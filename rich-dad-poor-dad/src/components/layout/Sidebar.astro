---
import { buildBookTree } from '@/utils/navigation'
import { BOOKS } from '@/utils/constants'
import type { BookId } from '@/utils/constants'

interface Props {
  currentBook?: string
  currentChapter?: number
}

const { currentBook, currentChapter } = Astro.props
const bookTree = await buildBookTree()
---

<aside
  id="sidebar"
  class="fixed top-14 left-0 z-40 h-[calc(100vh-3.5rem)] w-[280px] -translate-x-full overflow-y-auto border-r border-border bg-background transition-transform lg:translate-x-0"
>
  <nav class="p-4" aria-label="書籍ナビゲーション">
    <ul class="space-y-1">
      {
        bookTree.map((book) => {
          const isCurrentBook = book.bookId === currentBook
          const bookInfo = BOOKS[book.bookId as BookId]
          const bookTitle = bookInfo?.shortTitle || book.bookTitle

          return (
            <li>
              <button
                class:list={[
                  'sidebar-section-btn flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium transition-colors',
                  isCurrentBook
                    ? 'bg-card text-foreground'
                    : 'text-muted hover:bg-card hover:text-foreground',
                ]}
                data-section={book.bookId}
                aria-expanded={isCurrentBook ? 'true' : 'false'}
              >
                <svg
                  class:list={[
                    'h-3 w-3 shrink-0 transition-transform',
                    isCurrentBook ? 'rotate-90' : '',
                  ]}
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path d="M6 4l8 6-8 6V4z" />
                </svg>
                <span class="truncate">
                  {bookTitle}
                </span>
              </button>
              <ul
                class:list={[
                  'sidebar-lectures ml-4 space-y-0.5 overflow-hidden border-l border-border pl-3',
                  isCurrentBook ? '' : 'hidden',
                ]}
                data-section-lectures={book.bookId}
              >
                {book.chapters.map((chapter) => {
                  const isCurrentChapter =
                    isCurrentBook &&
                    chapter.chapterNumber === currentChapter

                  return (
                    <li>
                      <a
                        href={chapter.path}
                        class:list={[
                          'block rounded-md px-2 py-1.5 text-xs transition-colors',
                          isCurrentChapter
                            ? 'bg-accent/10 font-medium text-accent'
                            : 'text-muted hover:bg-card hover:text-foreground',
                        ]}
                      >
                        第{chapter.chapterNumber}章. {chapter.title}
                      </a>
                    </li>
                  )
                })}
              </ul>
            </li>
          )
        })
      }
    </ul>
  </nav>
</aside>

<script>
  // Toggle section expand/collapse
  document.querySelectorAll('.sidebar-section-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const section = btn.getAttribute('data-section')
      const lectures = document.querySelector(
        `[data-section-lectures="${section}"]`
      )
      const arrow = btn.querySelector('svg')

      if (lectures?.classList.contains('hidden')) {
        lectures.classList.remove('hidden')
        arrow?.classList.add('rotate-90')
        btn.setAttribute('aria-expanded', 'true')
      } else {
        lectures?.classList.add('hidden')
        arrow?.classList.remove('rotate-90')
        btn.setAttribute('aria-expanded', 'false')
      }
    })
  })
</script>
